# nginx-rabbitmq.sample.conf
# Place this in an nginx "stream" include, e.g.:
# - /etc/nginx/streams-enabled/ (Debian/Ubuntu with a custom include)
# - Or add "include /etc/nginx/streams-enabled/*.conf;" inside the top-level stream {} in nginx.conf

# Upstream to HAProxy on localhost (non-TLS)
upstream amqp_backend {
    server 127.0.0.1:5672;
    # Optionally set least_conn; round-robin is fine here since HAProxy balances to brokers.
    # least_conn;
}

# Public TLS endpoint for AMQP (amqps://) on 5671
server {
    listen 0.0.0.0:5671 ssl;
    # Replace with your domain FQDN used by clients (SNI and cert must match)
    # Example: queue.your-domain.com
    ssl_certificate     /etc/letsencrypt/live/queue.your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/queue.your-domain.com/privkey.pem;

    # Recommended hardening (adjust if you have legacy clients)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers   HIGH:!aNULL:!MD5;

    # AMQP connections can be long-lived; keep generous timeouts
    proxy_connect_timeout 5s;
    proxy_timeout 3h;

    # Forward decrypted TCP to HAProxy
    proxy_pass amqp_backend;
}

# Optional: expose plain AMQP 5672 via Nginx too (not recommended on public networks)
# server {
#     listen 0.0.0.0:5672;
#     proxy_connect_timeout 5s;
#     proxy_timeout 3h;
#     proxy_pass amqp_backend;
# }